on:
  workflow_dispatch:


name: revdep

jobs:
  revdep:
    
    strategy:
      fail-fast: false
      matrix: 
        cuda: ["111"]
    
    runs-on: [self-hosted, linux]
    
    env:
      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
      TORCH_TEST: 1
      TORCH_INSTALL: 1
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      DEBIAN_FRONTEND: 'noninteractive'
      CRAN: 'https://packagemanager.rstudio.com/all/__linux__/bionic/latest'
      
    container:
      image: nvidia/cuda:11.1-cudnn8-devel-ubuntu18.04
      options: --gpus all
      
    steps:
    
      - name: Clean up temp directory
        run: |
          rm -r $GITHUB_WORKSPACE/../../_temp/*
    
      - uses: actions/checkout@v2
      
      - run: |
          apt-get update -y
          apt-get install -y sudo software-properties-common dialog apt-utils tzdata libpng-dev libcurl4-openssl-dev libssl-dev libv8-dev
          
      - uses: r-lib/actions/setup-r@master
        with:
          r-version: 'release'

      - uses: r-lib/actions/setup-pandoc@v1

      - name: Install pak and query dependencies
        run: |
          options(repos=structure(c(CRAN=Sys.getenv("CRAN"))))
          install.packages("remotes")
          remotes::install_github("r-lib/pak")
          saveRDS(pak::pkg_deps_tree("local::.", dependencies = TRUE), ".github/r-depends.rds")
        shell: Rscript {0}

      - name: Install dependencies
        run: |
          pak::local_install_dev_deps(upgrade = TRUE)
          pak::pkg_install("rcmdcheck")
        shell: Rscript {0}
        
      - run: |
          pak::pkg_install("r-lib/revdepcheck")
        shell: Rscript {0}
        
      - name: Session info
        run: |
          options(width = 100)
          pkgs <- installed.packages()[, "Package"]
          sessioninfo::session_info(pkgs, include_base = TRUE)
        shell: Rscript {0}
  
      - name: Run revdep check
        run: |
          revdepcheck::revdep_check()
        shell: Rscript {0}
        
      - name: Remove library
        run: |
          rm -r revdep/library.noindex
      
      - name: Upload revdep results
        if: always()
        uses: actions/upload-artifact@main
        with:
          name: revdep-results
          path: revdep
